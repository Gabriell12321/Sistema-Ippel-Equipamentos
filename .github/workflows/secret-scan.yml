name: Secret scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install trufflehog3
        run: |
          python -m pip install --upgrade pip
          pip install trufflehog3

      - name: Run trufflehog3 scan
        run: |
          python -m trufflehog3 --format JSON --output trufflehog3-results.json . || true
          # If the results file exists and is non-empty, print a summary and fail the job
          if [ -f trufflehog3-results.json ] && [ -s trufflehog3-results.json ]; then
            echo "Secrets found by trufflehog3; printing summary and failing the job"
            python - <<'PY'
import json,sys
try:
    data=json.load(open('trufflehog3-results.json'))
except Exception:
    print('Failed to parse JSON output or empty')
    sys.exit(1)
# trufflehog3 uses keys 'results' in JSON in some versions
results = None
if isinstance(data, dict) and 'results' in data:
    results = data['results']
elif isinstance(data, list):
    results = data
else:
    results = data
count = len(results) if hasattr(results, '__len__') else 1
print(f"Findings: {count}")
# print only limited output to avoid huge logs
print(json.dumps(results, indent=2)[:8000])
sys.exit(1)
PY
          else
            echo "No secrets found by trufflehog3."
          fi

      - name: Upload trufflehog report
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog3-results.json
