
>         <script>
              // Flag para saber se √© modo Responder
              const IS_REPLY = {{ 'true' if is_reply else 'false' }};
              
              // DEFINIR FUN√á√ïES GLOBAIS ANTES DOS ELEMENTOS HTML
              console.log('üìù Definindo fun√ß√µes globais para edit_rnc_form...');
              
              // Fun√ß√£o para preencher assinatura automaticamente
              window.preencherAssinatura = function(elemento) {
                  console.log('‚úçÔ∏è Preenchendo assinatura...');
                  const nomeElement = elemento.querySelector('div[id^="nome_coluna"]');
                  
                  // Se j√° existe assinatura, n√£o permitir remover (travado)
                  if (nomeElement && nomeElement.textContent && nomeElement.textContent.trim() !== '' && nomeElement.textContent !== 'NOME') {
                      if (typeof mostrarNotificacao === 'function') {
                          mostrarNotificacao('‚ÑπÔ∏è Assinatura j√° registrada.');
                      } else {
                          alert('Assinatura j√° registrada.');
                      }
                      return;
                  }
                  
                  fetch('/api/user/info')
                      .then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              const nomeUsuario = data.user.name;
                              const departamento = data.user.department;
                              
                              if (nomeElement) {
                                  nomeElement.textContent = `${nomeUsuario} (${departamento})`;
                                  
                                  elemento.style.transform = 'scale(1.02)';
                                  elemento.style.transition = 'transform 0.2s ease';
                                  
                                  setTimeout(() => {
                                      elemento.style.transform = 'scale(1)';
                                  }, 200);
                                  
                                  if (typeof mostrarNotificacao === 'function') {
                                      mostrarNotificacao('‚úÖ Assinatura preenchida!');
                                  }
                                  
                                  // Preencher data correspondente e travar inputs
                                  const hoje = new Date();
                                  const d = String(hoje.getDate()).padStart(2,'0');
                                  const m = String(hoje.getMonth()+1).padStart(2,'0');
                                  const y = String(hoje.getFullYear());
                                  if (elemento.id === 'assinatura_coluna1') {
                                      setDateInputs('insp1', d, m, y);
                                  } else if (elemento.id === 'assinatura_coluna2') {
                                      setDateInputs('eng', d, m, y);
                                  } else if (elemento.id === 'assinatura_coluna3') {
                                      setDateInputs('insp2', d, m, y);
                                  }
                              }
                          } else {
                              if (typeof mostrarNotificacao === 'function') {
                                  mostrarNotificacao('‚ùå Erro: Usu√°rio n√£o autenticado', 'error');
                              } else {
                                  alert('Erro: Usu√°rio n√£o autenticado');
                              }
                          }
                      })
                      .catch(error => {
                          console.error('Erro ao buscar informa√ß√µes do usu√°rio:', error);
                          if (typeof mostrarNotificacao === 'function') {
                              mostrarNotificacao('‚ùå Erro ao preencher assinatura', 'error');
                          } else {
                              alert('Erro ao preencher assinatura');
                          }
                      });
              };
              
              window.setDateInputs = function(prefix, d, m, y) {
                  const di = document.getElementById(prefix + '_d');
                  const mi = document.getElementById(prefix + '_m');
                  const yi = document.getElementById(prefix + '_y');
                  if (di && mi && yi) {
                      di.value = d; mi.value = m; yi.value = y;
                      di.readOnly = true; mi.readOnly = true; yi.readOnly = true;
                      di.style.pointerEvents='none'; mi.style.pointerEvents='none'; yi.style.pointerEvents='none';
                  }
              };
              
              // Fun√ß√£o verificarAssinaturas (necess√°ria para salvarAlteracoes)
              window.verificarAssinaturas = function() {
                  console.log('üîç Verificando assinaturas...');
                  const assinaturas = [
                      document.getElementById('nome_coluna1')?.textContent || '',
                      document.getElementById('nome_coluna2')?.textContent || '',
                      document.getElementById('nome_coluna3')?.textContent || ''
                  ];
                  console.log('   Assinaturas encontradas:', assinaturas);
                  return assinaturas.some(assinatura => assinatura && assinatura !== 'NOME' && assinatura.trim() !== '');
              };
              
              // Fun√ß√£o mostrarNotificacao (necess√°ria para outras fun√ß√µes)
              window.mostrarNotificacao = function(mensagem, tipo = 'success') {
                  console.log('üì¢ Notifica√ß√£o:', tipo, '-', mensagem);
                  
                  const notificacao = document.createElement('div');
                  notificacao.textContent = mensagem;
                  notificacao.style.cssText = `
                      position: fixed;
                      top: 20px;
                      right: 20px;
                      padding: 15px 25px;
                      background: ${tipo === 'error' ? '#dc3545' : tipo === 'warning' ? '#ffc107' : '#28a745'};
                      color: white;
                      border-radius: 8px;
                      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                      z-index: 10000;
                      font-size: 14px;
                      font-weight: 600;
                      animation: slideIn 0.3s ease;
                  `;
                  
                  document.body.appendChild(notificacao);
                  
                  setTimeout(() => {
                      notificacao.style.opacity = '0';
                      notificacao.style.transition = 'opacity 0.3s';
                      setTimeout(() => {
                          if (document.body.contains(notificacao)) {
                              document.body.removeChild(notificacao);
                          }
                      }, 300);
                  }, 3000);
              };
              
              console.log('‚úì Fun√ß√µes globais definidas com sucesso');
          </script>
          <!-- Banner de modo de edi√ß√£o (apenas para edi√ß√£o, n√£o para resposta) -->
          {% if not is_reply %}
          <div class="edit-mode-banner">
              ‚úèÔ∏è MODO DE EDI√á√ÉO - RNC: {{ rnc.rnc_number }}
          </div>
          {% endif %}
  
          <!-- Header with Logo -->
          <div class="header">
              <div class="logos" style="display:flex; gap:12px; align-items:center;">
                  <img src="{{ url_for('static', filename='LOGOSQI.jpg') }}" alt="SQI Logo" style="width: 120px; height: 120px; border-radius: 15px; object-fit: contain; background: transparent; padding: 0; border: none;">
                  <img src="/IPPELLOGO.jpg" alt="IPPEL Logo" class="apply-logo" style="width: 120px; height: 120px; border-radius: 15px; object-fit: contain; background: transparent; padding: 0; border: none;"
                       data-logo-primary="/IPPELLOGO.jpg"
                       data-logo-fallback1="/IPPELLOGO.jpg"
                       data-logo-fallback2="{{ url_for('static', filename='LOGOSQI.jpg') }}"
                       onerror="if(this.dataset.try1!=='1'){this.dataset.try1='1'; this.src=this.dataset.logoFallback1;} else if(this.dataset.try2!=='1'){this.dataset.try2='1'; this.src=this.dataset.logoFallback2;} else {this.style.display='none';}">
              </div>
              <div style="position: absolute; top: 20px; right: 30px; font-size: 12px; color: #6c757d; font-weight: 500; z-index: 10;">
                  v2.0 | Sistema Premium
              </div>
          </div>
  
          <!-- Title Section -->
          <div class="title-section">
              <div style="margin-bottom: 10px;">
                  <div style="width: 60px; height: 2px; background: linear-gradient(90deg, transparent, #6c757d, transparent); margin: 0 auto;"></div>
              </div>
              <div class="main-title">Relat√≥rio De N√£o Conformidades Internas ‚Äì RNC</div>
              <div class="subtitle">FABRICA√á√ÉO / RECEBIMENTO</div>
          </div>
  
          <!-- Form Code -->
          <div class="form-code">FQ ‚Äì 002</div>
  
          <!-- RNC Number -->
          <div class="rnc-number" style="text-align: center; margin-bottom: 20px;">
              <label style="font-weight: 600; color: #495057; margin-right: 10px;">RNC N¬∫.:</label>
              <input type="text" id="rnc_number" name="rnc_number" value="{{ rnc.rnc_number }}" 
                     style="border: 1px solid #000; border-radius: 5px; padding: 8px; width: 200px; font-weight: 600;">
          </div>
  
          <!-- ============================================ -->
          <!-- SE√á√ÉO: DESENHO -->
          <!-- ============================================ -->
          <div style="margin: 25px 0; border: 1px solid #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
  
              <!-- Cabe√ßalho da Se√ß√£o -->
              <div style="background: white; color: black; padding: 12px 20px; font-weight: bold; font-size: 15px; text-align: center; letter-spacing: 1px;">
                   DESENHO
              </div>
  
              <!-- Conte√∫do -->
              <div style="padding: 20px; background: white;">
                  <!-- Linha 1: CLIENTES | NUMERO DE DESENHO | REVIS√ÉO -->
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="field-label" style="width: 33.33%;">CLIENTES</td>
                          <td class="field-label" style="width: 33.33%;">NUMERO DE DESENHO</td>
                          <td class="field-label" style="width: 33.33%;">REVIS√ÉO</td>
                      </tr>
                      <tr>
                          <td>
                              <select id="client" name="client" class="input-field" data-field="client" style="padding: 8px; cursor: pointer;">
                                  <option value="">Selecione o cliente</option>
                                  {% for client in clients %}
                                  <option value="{{ client }}" {% if rnc.client == client %}selected{% endif %}>{{ client }}</option>
                                  {% endfor %}
                              </select>
                          </td>
                          <td><input type="text" name="drawing" class="input-field" placeholder="N√∫mero do Desenho" data-field="drawing" value="{{ rnc.title or txt_fields.get('Desenho') or '' }}"></td>
                          <td><input type="text" name="revision" class="input-field" placeholder="Revis√£o" data-field="revision" value="{{ rnc.revision or txt_fields.get('Revis√£o') or txt_fields.get('REVISAO') or '' }}"></td>
                      </tr>
                  </table>
  
                  <!-- Linha 2: CONJ. | EQUIPAMENTO -->
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="field-label" style="width: 50%;">CONJ.</td>
                          <td class="field-label" style="width: 50%;">EQUIPAMENTO</td>
                      </tr>
                      <tr>
                          <td><input type="text" name="conjunto" class="input-field" placeholder="Conjunto" data-field="conjunto" value="{{ rnc.conjunto or txt_fields.get('Conjunto') or '' }}"></td>
                          <td><input type="text" id="equipment" name="equipment" class="input-field" placeholder="Equipamento" data-field="equipment" value="{{ rnc.equipment or '' }}"></td>
                      </tr>
                  </table>
  
                  <!-- Linha 3: DESCRI√á√ÉO -->
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="field-label" style="width: 100%;">DESCRI√á√ÉO</td>
                      </tr>
                      <tr>
                          <td><input type="text" name="description_drawing" class="input-field" placeholder="Descri√ß√£o do desenho" data-field="description_drawing" value="{{ rnc.description_drawing or txt_fields.get('Descri√ß√£o da RNC') or txt_fields.get('Descri√ß√£o do desenho') or '' }}"></td>
                      </tr>
                  </table>
  
                  <!-- üîñ CAMPOS MOVIDOS PARA SE√á√ÉO COMPLEMENTARES -->
                  <!-- CV, MOD, QTDE LOTE, MATERIAL, POSI√á√ÉO, MP e VALOR TOTAL agora est√£o na se√ß√£o COMPLEMENTARES abaixo -->
              </div>
          </div>
  
          <!-- ============================================ -->
          <!-- SE√á√ÉO: COMPLEMENTARES -->
          <!-- ============================================ -->
          <div style="margin: 20px 0; border: 1px solid #2c3e50; border-radius: 8px; overflow: hidden; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);">
              <!-- Cabe√ßalho da Se√ß√£o -->
              <div style="background: linear-gradient(135deg, #34495e, #2c3e50); color: white; padding: 10px 15px; font-weight: bold; font-size: 14px; text-align: center; letter-spacing: 1px;">
                   COMPLEMENTARES
              </div>
  
              <!-- Conte√∫do -->
              <div style="padding: 12px 15px; background: #f8f9fa;">
                  <!-- Linha 1: POSI√á√ÉO | MODELO | MATERIAL | QUANTIDADE -->
                  <table style="margin-bottom: 8px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;">
                      <tr>
                          <td class="field-label" style="width: 25%; background: #e9ecef; font-size: 12px; padding: 6px;">POSI√á√ÉO</td>
                          <td class="field-label" style="width: 25%; background: #e9ecef; font-size: 12px; padding: 6px;">MODELO</td>
                          <td class="field-label" style="width: 25%; background: #e9ecef; font-size: 12px; padding: 6px;">MATERIAL</td>
                          <td class="field-label" style="width: 25%; background: #e9ecef; font-size: 12px; padding: 6px;">QUANTIDADE</td>
                      </tr>
                      <tr>
                          <td style="padding: 4px;"><input type="text" name="position" class="input-field" placeholder="Posi√ß√£o" data-field="position" style="height: 38px; font-size: 13px;" value="{{ rnc.position or txt_fields.get('POS') or '' }}"></td>
                          <td style="padding: 4px;"><input type="text" name="modelo" class="input-field" placeholder="Modelo" data-field="modelo" style="height: 38px; font-size: 13px;" value="{{ rnc.modelo or txt_fields.get('Modelo') or '' }}"></td>
                          <td style="padding: 4px;"><input type="text" name="material" class="input-field" placeholder="Material" data-field="material" style="height: 38px; font-size: 13px;" value="{{ rnc.material or txt_fields.get('Material') or '' }}"></td>
                          <td style="padding: 4px;"><input type="number" id="quantity" name="quantity" class="input-field" placeholder="Quantidade" data-field="quantity" min="0" step="1" style="height: 38px; font-size: 13px;" value="{{ rnc.quantity or txt_fields.get('Quantidade') or '' }}"></td>
                      </tr>
                  </table>
  
                  <!-- Linha 2: CV | MP -->
                  <table style="margin-bottom: 8px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;">
                      <tr>
                          <td class="field-label" style="width: 50%; background: #e9ecef; font-size: 12px; padding: 6px;">CV</td>
                          <td class="field-label" style="width: 50%; background: #e9ecef; font-size: 12px; padding: 6px;">MP</td>
                      </tr>
                      <tr>
                          <td style="padding: 4px;"><input type="text" name="cv" class="input-field" placeholder="CV" data-field="cv" style="height: 38px; font-size: 13px;" value="{{ rnc.cv or txt_fields.get('CV') or '' }}"></td>
                          <td style="padding: 4px;"><input type="text" name="mp" class="input-field" placeholder="MP" data-field="mp" style="height: 38px; font-size: 13px;" value="{{ rnc.mp or txt_fields.get('MP') or '' }}"></td>
                      </tr>
                  </table>
  
                  <!-- Linha 3: VALOR TOTAL | OBSERVA√á√ÉO -->
                  <table style="margin-bottom: 0; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden;">
                      <tr>
                          <td class="field-label" style="width: 50%; background: #e9ecef; font-size: 12px; padding: 6px;">VALOR TOTAL (R$)</td>
                          <td class="field-label" style="width: 50%; background: #e9ecef; font-size: 12px; padding: 6px;">OBSERVA√á√ÉO</td>
                      </tr>
                      <tr>
                          <td style="position: relative; padding: 4px;">
                              <input type="text" id="price" name="price" class="input-field" placeholder="R$ 0,00" data-field="price"
                                     inputmode="decimal" autocomplete="off" readonly style="background: #f8f9fa; cursor: pointer; height: 38px; font-size: 13px;"
                                     value="{% if rnc.price %}R$ {{ ('%.2f' % (rnc.price|float)).replace('.', ',') }}{% else %}{% endif %}">
                              <button type="button" onclick="openValoresSelectionModal()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); padding: 6px 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                  Adicionar
                              </button>
                              <!-- Lista de itens selecionados -->
                              <div id="selectedValoresList" style="margin-top: 8px; max-height: 180px; overflow-y: auto; display: none; border: 1px solid #ddd; border-radius: 4px; padding: 8px; background: white;">
                                  <!-- Itens ser√£o adicionados aqui dinamicamente -->
                              </div>
                          </td>
                          <td style="padding: 4px;"><input type="text" id="price_note" class="input-field" placeholder="Ex.: custo estimado, nota de or√ßamento" data-field="price_note" style="height: 38px; font-size: 13px;" value="{{ rnc.price_note or '' }}"></td>
                      </tr>
                  </table>
              </div>
          </div>
  
          <!-- ============================================ -->
          <!-- SE√á√ÉO: ASSINATURAS CABE√áALHO -->
          <!-- ============================================ -->
          <div style="margin: 25px 0; border: 1px solid #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
              <!-- Cabe√ßalho da Se√ß√£o -->
              <div style="background: white; color: black; padding: 12px 20px; font-weight: bold; font-size: 15px; text-align: center; letter-spacing: 1px;">
                   ASSINATURAS CABE√áALHO
              </div>
  
              <!-- Conte√∫do -->
              <div style="padding: 20px; background: white;">
                  <!-- Linha 1: Setor respons√°vel | Assinatura respons√°vel | Data -->
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="field-label" style="width: 33.33%;">SETOR RESPONS√ÅVEL</td>
                          <td class="field-label" style="width: 33.33%;">ASSINATURA RESPONS√ÅVEL</td>
                          <td class="field-label" style="width: 33.33%;">DATA</td>
                      </tr>
                      <tr>
                          <td>
                              <select id="area_responsavel_select" name="area_responsavel" class="input-field" data-field="area_responsavel" onchange="onAreaResponsavelChange()" style="padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%; background: white; cursor: pointer; transition: all 0.2s;">
                                  <option value="">Selecione a √Årea Respons√°vel</option>
                              </select>
                          </td>
                          <td><input type="text" id="ass_responsavel" name="ass_responsavel" class="input-field" placeholder="Assinatura Respons√°vel" data-field="signature_inspection_name" value="{{ rnc.signature_inspection_name or '' }}"></td>
                          <td><input type="text" id="data_emissao" name="data_emissao" class="input-field" data-field="created_at" value="{{ (rnc.created_at or '')[:10] if rnc.created_at else '' }}"></td>
                      </tr>
                  </table>
  
                  <!-- Linha 2: Inspetor | Nome causador | Assinatura Causador -->
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="field-label" style="width: 33.33%;">INSPETOR</td>
                          <td class="field-label" style="width: 33.33%;">NOME CAUSADOR</td>
                          <td class="field-label" style="width: 33.33%;">ASSINATURA CAUSADOR</td>
                      </tr>
                      <tr>
                          <td><input type="text" name="inspetor" class="input-field" placeholder="Inspetor" data-field="inspetor" value="{{ rnc.inspetor or '' }}"></td>
                          <td>
                              <select id="nome_responsavel" name="nome_responsavel" class="input-field" data-field="responsavel" onchange="onNomeResponsavelChange()" style="padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; width: 100%; background: white; cursor: pointer; transition: all 0.2s;">
                                  <option value="">Selecione o Usu√°rio Causador</option>
                              </select>
                          </td>
                          <td><input type="text" name="assinatura_lider" id="assinatura_lider" class="input-field" placeholder="Digite a assinatura manualmente" data-field="signature_inspection2_name" value="{{ rnc.signature_inspection2_name or '' }}"></td>
                      </tr>
                  </table>
              </div>
          </div>
  
          <!-- ============================================ -->
          <!-- SE√á√ÉO: DESCRI√á√ÉO DA N√ÉO CONFORMIDADE -->
          <!-- ============================================ -->
          <div style="margin: 25px 0; border: 1px solid #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
              <!-- Cabe√ßalho da Se√ß√£o -->
              <div style="background: white; color: black; padding: 12px 20px; font-weight: bold; font-size: 15px; text-align: center; letter-spacing: 1px;">
                   DESCRI√á√ÉO DA N√ÉO CONFORMIDADE
              </div>
  
              <!-- Conte√∫do -->
              <div style="padding: 20px; background: white;">
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="item-column">ITEM</td>
                          <td class="section-title">DESCRI√á√ÉO DA N√ÉO CONFORMIDADE</td>
                      </tr>
                      <tr>
                          <td style="width: 60px;"></td>
                          <td><textarea id="description" name="description" class="input-field large-text-area" placeholder="Descreva a n√£o conformidade identificada...">{{ txt_fields.get('Descri√ß√£o da RNC', '') or txt_fields.get('Descri√ß√£o do desenho', '') or rnc.description or '' }}</textarea></td>
                      </tr>
                  </table>
              </div>
          </div>
  
          <!-- ============================================ -->
          <!-- SE√á√ÉO: INSTRU√á√ÉO PARA RETRABALHO -->
          <!-- ============================================ -->
          <div style="margin: 25px 0; border: 1px solid #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
              <!-- Cabe√ßalho da Se√ß√£o -->
              <div style="background: white; color: black; padding: 12px 20px; font-weight: bold; font-size: 15px; text-align: center; letter-spacing: 1px;">
                   INSTRU√á√ÉO PARA RETRABALHO
              </div>
  
              <!-- Conte√∫do -->
              <div style="padding: 20px; background: white;">
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="item-column">ITEM</td>
                          <td class="section-title">INSTRU√á√ÉO PARA RETRABALHO</td>
                      </tr>
                      <tr>
                          <td style="width: 60px;"></td>
                          <td><textarea id="instruction_retrabalho" class="input-field medium-text-area" placeholder="Instru√ß√µes detalhadas para corre√ß√£o...">{{ rnc.instruction_retrabalho or '' }}</textarea></td>
                      </tr>
                  </table>
              </div>
          </div>
  
          <!-- ============================================ -->
          <!-- SE√á√ÉO: CAUSA DA RNC -->
          <!-- ============================================ -->
          <div style="margin: 25px 0; border: 1px solid #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
              <!-- Cabe√ßalho da Se√ß√£o -->
              <div style="background: white; color: black; padding: 12px 20px; font-weight: bold; font-size: 15px; text-align: center; letter-spacing: 1px;">
                   CAUSA DA RNC
              </div>
  
              <!-- Conte√∫do -->
              <div style="padding: 20px; background: white;">
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="item-column">ITEM</td>
                          <td class="section-title">CAUSA DA RNC</td>
                      </tr>
                      <tr>
                          <td style="width: 60px;"></td>
                          <td><textarea id="cause_rnc" class="input-field medium-text-area" placeholder="An√°lise da causa raiz...">{{ rnc.cause_rnc or '' }}</textarea></td>
                      </tr>
                  </table>
              </div>
          </div>
  
          <!-- ============================================ -->
          <!-- SE√á√ÉO: A√á√ÉO A SER TOMADA -->
          <!-- ============================================ -->
          <div style="margin: 25px 0; border: 1px solid #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
              <!-- Cabe√ßalho da Se√ß√£o -->
              <div style="background: white; color: black; padding: 12px 20px; font-weight: bold; font-size: 15px; text-align: center; letter-spacing: 1px;">
                   A√á√ÉO A SER TOMADA
              </div>
  
              <!-- Conte√∫do -->
              <div style="padding: 20px; background: white;">
                  <table style="margin-bottom: 0;">
                      <tr>
                          <td class="item-column">ITEM</td>
                          <td class="section-title">A√á√ÉO A SER TOMADA</td>
                      </tr>
                      <tr>
                          <td style="width: 60px;"></td>
                          <td><textarea id="action_rnc" class="input-field medium-text-area" placeholder="A√ß√µes corretivas e preventivas...">{{ rnc.action_rnc or '' }}</textarea></td>
                      </tr>
                  </table>
              </div>
          </div>
  
          <!-- ============================================ -->
          <!-- SE√á√ÉO: DISPOSI√á√ÉO E INSPE√á√ÉO -->
          <!-- ============================================ -->
          <div style="margin: 25px 0; border: 1px solid #000; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
              <!-- Cabe√ßalho da Se√ß√£o -->
              <div style="background: white; color: black; padding: 12px 20px; font-weight: bold; font-size: 15px; text-align: center; letter-spacing: 1px;">
                   DISPOSI√á√ÉO E INSPE√á√ÉO
              </div>
  
              <!-- Conte√∫do -->
              <div style="padding: 20px; background: white;">
                  <!-- Header Banner -->
                  <div style="width: 100%; background: #6c757d; color: white; text-align: center; padding: 12px 0; margin-bottom: 0; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 14px; display: flex;">
                      <div style="width: 50%; text-align: center; border-right: 1px solid white;">DISPOSI√á√ÉO DO MATERIAL N√ÉO-CONFORME</div>
                      <div style="width: 50%; text-align: center;">INSPE√á√ÉO DO RETRABALHO</div>
                  </div>
  
                  <!-- Main Content Section -->
                  <div style="border: 1px solid #000; border-top: none; border-radius: 0 0 8px 8px; background: white; display: flex;">
                      <!-- Left Section: Disposi√ß√£o do Material -->
                      <div style="width: 50%; padding: 15px; border-right: 1px solid #000;">
                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; font-weight: bold;">
                              <div style="display: flex; align-items: center;">
                                  <input type="checkbox" id="usar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #6c757d;" {% if rnc.disposition_usar %}checked{% endif %}>
                                  <label for="usar">USAR COMO EST√Å</label>
                              </div>
                              <div style="display: flex; align-items: center;">
                                  <input type="checkbox" id="retrabalhar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #6c757d;" {% if rnc.disposition_retrabalhar %}checked{% endif %}>
                                  <label for="retrabalhar">RETRABALHAR</label>
                              </div>
                              <div style="display: flex; align-items: center;">
                                  <input type="checkbox" id="rejeitar" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #6c757d;" {% if rnc.disposition_rejeitar %}checked{% endif %}>
                                  <label for="rejeitar">REJEITAR</label>
                              </div>
                              <div style="display: flex; align-items: center;">
                                  <input type="checkbox" id="sucata" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #6c757d;" {% if rnc.disposition_sucata %}checked{% endif %}>
                                  <label for="sucata">SUCATA</label>
                              </div>
                              <div style="display: flex; align-items: center;">
                                  <input type="checkbox" id="devolver_estoque" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #6c757d;" {% if rnc.disposition_devolver_estoque %}checked{% endif %}>
                                  <label for="devolver_estoque">DEVOLVER AO ESTOQUE</label>
                              </div>
                              <div style="display: flex; align-items: center;">
                                  <input type="checkbox" id="devolver_fornecedor" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #6c757d;" {% if rnc.disposition_devolver_fornecedor %}checked{% endif %}>
                                  <label for="devolver_fornecedor">DEVOLVER AO FORNECEDOR</label>
                              </div>
                          </div>
                      </div>
  
                      <!-- Right Section: Inspe√ß√£o do Retrabalho -->
                      <div style="width: 50%; padding: 15px;">
                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; font-weight: bold;">
                              <div style="display: flex; align-items: center;">
                                  <input type="checkbox" id="aprovado" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #28a745;" {% if rnc.inspection_aprovado %}checked{% endif %}>
                                  <label for="aprovado">APROVADO</label>
                              </div>
                              <div style="display: flex; align-items: center;">
                                  <input type="checkbox" id="reprovado" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #dc3545;" {% if rnc.inspection_reprovado %}checked{% endif %}>
>     <script>
          // ===== Recursos de sele√ß√£o de valores (edi√ß√£o/resposta) =====
          let selectedValoresData = [];
          let valoresHoraDatabase = [];
  
          function timeToDecimal(timeStr) {
              const parts = String(timeStr || '0:00').split(':');
              const hours = parseInt(parts[0]) || 0;
              const minutes = parseInt(parts[1]) || 0;
              return hours + (minutes / 60);
          }
  
          function decimalToTime(decimal) {
              const hours = Math.floor(decimal || 0);
              const minutes = Math.round(((decimal || 0) - hours) * 60);
              return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
          }
  
          function generateTimeOptions(selectedValue = '01:00') {
              const times = [
                  '00:05','00:10','00:15','00:20','00:25','00:30','00:35','00:40','00:45','00:50','00:55','01:00',
                  '01:05','01:10','01:15','01:20','01:25','01:30','01:35','01:40','01:45','01:50','01:55','02:00',
                  '02:30','03:00','03:30','04:00','04:30','05:00','06:00','07:00','08:00','09:00','10:00','12:00',
                  '16:00','20:00','24:00','32:00','40:00','48:00'
              ];
              return times.map(t => `<option value="${t}" ${t===selectedValue?'selected':''}>${t}</option>`).join('');
          }
  
          async function loadValoresHoraDatabase() {
              try {
                  const r = await fetch('/api/valores-hora/list');
                  const j = await r.json();
                  if (j && j.success && Array.isArray(j.valores)) {
                      valoresHoraDatabase = j.valores;
                      populateValoresSelectionTable();
                  }
              } catch (e) {
                  console.error('Erro ao carregar valores/hora:', e);
              }
          }
  
          function populateValoresSelectionTable() {
              const tbody = document.getElementById('valoresSelectionTableBody');
              if (!tbody) return;
              tbody.innerHTML = '';
              let currentSetor = '';
              (valoresHoraDatabase || []).forEach(item => {
                  if (item.setor && item.setor !== currentSetor) {
                      currentSetor = item.setor;
                      const setorRow = document.createElement('tr');
                      setorRow.className = 'setor-header';
                      setorRow.innerHTML = `<td colspan="6" style="background:#8b1538;color:#fff;font-weight:bold;padding:10px;font-size:14px;">${currentSetor}</td>`;
                      tbody.appendChild(setorRow);
                  }
                  const isSelected = selectedValoresData.some(v => v.codigo === item.codigo);
                  const horasValue = isSelected ? (selectedValoresData.find(v => v.codigo === item.codigo).horas_formatted || '01:00') : '01:00';
                  const horasDecimal = timeToDecimal(horasValue);
                  const row = document.createElement('tr');
                  row.className = 'valor-selection-row';
                  row.setAttribute('data-codigo', item.codigo);
                  const selectStyle = isSelected ? 'width:100%;padding:6px;border:1px solid #ced4da;border-radius:4px;text-align:center;font-size:13px;cursor:pointer;background:white;' : 'width:100%;padding:6px;border:1px solid #ced4da;border-radius:4px;text-align:center;font-size:13px;cursor:not-allowed;background:#e9ecef;color:#6c757d;';
                  row.innerHTML = `
                      <td style="padding:10px;text-align:center;border-bottom:1px solid #e9ecef;"><input type="checkbox" class="valor-checkbox" value="${item.codigo}" ${isSelected?'checked':''} onchange="toggleValorSelection('${item.codigo}')" style="width:18px;height:18px;cursor:pointer;"></td>
                      <td style="padding:10px;border-bottom:1px solid #e9ecef;font-weight:600;color:#495057;">${item.codigo}</td>
                      <td style="padding:10px;border-bottom:1px solid #e9ecef;color:#6c757d;">${item.descricao}</td>
                      <td style="padding:10px;text-align:right;border-bottom:1px solid #e9ecef;color:#28a745;font-weight:600;">R$ ${(parseFloat(item.valor_hora)||0).toFixed(2).replace('.', ',')}</td>
                      <td style="padding:10px;text-align:center;border-bottom:1px solid #e9ecef;"><select class="horas-input" data-codigo="${item.codigo}" ${isSelected?'':'disabled'} onchange="updateHorasForValor('${item.codigo}', this.value)" style="${selectStyle}">${generateTimeOptions(horasValue)}</select></td>
                      <td style="padding:10px;text-align:right;border-bottom:1px solid #e9ecef;font-weight:700;color:#007bff;" class="subtotal-cell" data-codigo="${item.codigo}">R$ ${((parseFloat(item.valor_hora)||0) * horasDecimal).toFixed(2).replace('.', ',')}</td>
                  `;
                  if (isSelected) row.style.background = '#e7f5ff';
                  tbody.appendChild(row);
              });
              updateModalTotal();
          }
  
          async function openValoresSelectionModal() {
              const modal = document.getElementById('valoresSelectionModal');
              if (!modal) return;
              modal.style.display = 'block';
              document.body.style.overflow = 'hidden';
              if (valoresHoraDatabase.length === 0) {
                  await loadValoresHoraDatabase();
              } else {
                  populateValoresSelectionTable();
              }
          }
          function closeValoresSelectionModal() {
              const modal = document.getElementById('valoresSelectionModal');
              if (!modal) return;
              modal.style.display = 'none';
              document.body.style.overflow = 'auto';
          }
          function toggleValorSelection(codigo) {
              const checkbox = document.querySelector(`.valor-checkbox[value="${codigo}"]`);
              if (!checkbox) return;
              const row = checkbox.closest('tr');
              const horasInput = row ? row.querySelector('.horas-input') : null;
              if (checkbox.checked) {
                  const valorItem = (valoresHoraDatabase||[]).find(v => v.codigo === codigo);
                  if (valorItem) {
                      const horasFormatted = (horasInput && horasInput.value) || '01:00';
                      const horasDecimal = timeToDecimal(horasFormatted);
                      selectedValoresData.push({ codigo: valorItem.codigo, descricao: valorItem.descricao, setor: valorItem.setor, valor_hora: parseFloat(valorItem.valor_hora)||0, horas: horasDecimal, horas_formatted: horasFormatted, subtotal: (parseFloat(valorItem.valor_hora)||0) * horasDecimal });
                      if (horasInput) { horasInput.disabled = false; horasInput.style.cursor = 'pointer'; horasInput.style.backgroundColor = 'white'; }
                      if (row) row.style.background = '#e7f5ff';
                  }
              } else {
                  selectedValoresData = selectedValoresData.filter(v => v.codigo !== codigo);
                  if (horasInput) { horasInput.disabled = true; horasInput.style.cursor = 'not-allowed'; horasInput.style.backgroundColor = '#e9ecef'; horasInput.value = '01:00'; }
                  if (row) row.style.background = '';
              }
              updateModalTotal();
              updateSelectedCount();
          }
          function updateHorasForValor(codigo, horasFormatted) {
              const horasDecimal = timeToDecimal(horasFormatted);
              const item = selectedValoresData.find(v => v.codigo === codigo);
              if (item) {
                  item.horas = horasDecimal;
                  item.horas_formatted = horasFormatted;
                  item.subtotal = (parseFloat(item.valor_hora)||0) * horasDecimal;
              }
              const cell = document.querySelector(`.subtotal-cell[data-codigo="${codigo}"]`);
              if (cell) cell.textContent = `R$ ${item.subtotal.toFixed(2).replace('.', ',')}`;
              updateModalTotal();
          }
          // Fun√ß√£o para remover duplica√ß√£o de M√°quina/Funcion√°rio com mesmo valor
          function removeDuplicatesMaquinaFuncionario(items) {
              if (!items || items.length === 0) return items;
              
              // Agrupar por subtotal (valor final igual)
              const bySubtotal = {};
              items.forEach(item => {
                  const key = item.subtotal.toFixed(2);
                  if (!bySubtotal[key]) bySubtotal[key] = [];
                  bySubtotal[key].push(item);
              });
              
              // Para cada grupo de subtotal igual, verificar se tem M√°quina E Funcion√°rio
              const result = [];
              Object.values(bySubtotal).forEach(group => {
                  if (group.length === 1) {
                      // N√£o tem duplica√ß√£o, adiciona normalmente
                      result.push(group[0]);
                  } else {
                      // Verificar se tem M√°quina e Funcion√°rio (ou termos similares)
                      const hasMaquina = group.some(it => /m√°quina|maquina|equipamento|cnc|plasma|oxicorte|corte/i.test(it.descricao));
                      const hasFuncionario = group.some(it => /funcion√°rio|funcionario|operador|pessoa|m√£o.*obra|mao.*obra/i.test(it.descricao));
                      
                      if (hasMaquina && hasFuncionario) {
                          // Tem ambos com mesmo valor - DUPLICA√á√ÉO DETECTADA!
                          // Manter apenas o item de Funcion√°rio (remove M√°quina)
                          const funcionarioItem = group.find(it => /funcion√°rio|funcionario|operador|pessoa|m√£o.*obra|mao.*obra/i.test(it.descricao));
                          if (funcionarioItem) {
                              result.push(funcionarioItem);
                              console.log(`‚ö†Ô∏è Duplica√ß√£o removida: M√°quina e Funcion√°rio com valor R$ ${funcionarioItem.subtotal.toFixed(2)} - mantido apenas Funcion√°rio`);
                          } else {
                              // Fallback: manter o primeiro item
                              result.push(group[0]);
                          }
                      } else {
                          // N√£o √© caso de M√°quina+Funcion√°rio, adiciona todos
                          result.push(...group);
                      }
                  }
              });
              
              return result;
          }
          
          function updateModalTotal() {
              // Remover duplica√ß√µes antes de calcular total
              const itemsUnique = removeDuplicatesMaquinaFuncionario(selectedValoresData || []);
              const total = itemsUnique.reduce((s, it) => s + (it.subtotal||0), 0);
              const el = document.getElementById('modalTotalValue');
              if (el) el.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
          }
          function updateSelectedCount() {
              const el = document.getElementById('selectedValoresCount');
              if (el) el.textContent = (selectedValoresData||[]).length;
          }
          function toggleAllValores() {
              const selectAll = document.getElementById('selectAllValores');
              const checkboxes = document.querySelectorAll('.valor-checkbox');
              checkboxes.forEach(cb => { if (cb.checked !== (selectAll && selectAll.checked)) { cb.checked = !!(selectAll && selectAll.checked); toggleValorSelection(cb.value); } });
          }
          function clearValoresSelection() {
              if ((selectedValoresData||[]).length === 0) return;
              if (!confirm('Deseja limpar todos os valores selecionados?')) return;
              selectedValoresData = [];
              const checkboxes = document.querySelectorAll('.valor-checkbox');
              checkboxes.forEach(cb => { cb.checked = false; const row = cb.closest('tr'); const horasInput = row ? row.querySelector('.horas-input') : null; if (horasInput){ horasInput.disabled = true; horasInput.value = '01:00'; horasInput.style.cursor = 'not-allowed'; horasInput.style.backgroundColor = '#e9ecef'; } if (row) row.style.background = ''; });
              const sa = document.getElementById('selectAllValores'); if (sa) sa.checked = false;
              updateModalTotal();
              updateSelectedCount();
          }
          function applyValoresSelection() {
              if ((selectedValoresData||[]).length === 0) { alert('Selecione pelo menos um item!'); return; }
              // Remover duplica√ß√µes antes de aplicar
              const itemsUnique = removeDuplicatesMaquinaFuncionario(selectedValoresData);
              const total = itemsUnique.reduce((s, it) => s + (it.subtotal||0), 0);
              const priceInput = document.getElementById('price');
              if (priceInput) priceInput.value = `R$ ${total.toFixed(2).replace('.', ',')}`;
              
              // Atualizar selectedValoresData com lista sem duplica√ß√µes
              selectedValoresData = itemsUnique;
              
              displaySelectedValoresList();
              closeValoresSelectionModal();
          }
          function displaySelectedValoresList() {
              const listDiv = document.getElementById('selectedValoresList');
              if (!listDiv) return;
              if ((selectedValoresData||[]).length === 0) { listDiv.style.display = 'none'; return; }
              listDiv.style.display = 'block';
              
              // Usar lista sem duplica√ß√µes
              const itemsToDisplay = selectedValoresData;
              const total = itemsToDisplay.reduce((s, it) => s + (it.subtotal||0), 0);
              
              listDiv.innerHTML = `
                  <div style="margin-bottom:10px;font-weight:600;color:#495057;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #dee2e6;padding-bottom:8px;">
                      <span>Itens do Or√ßamento</span>
                      <span style="color:#28a745;font-size:16px;">Total: R$ ${total.toFixed(2).replace('.', ',')}</span>
                  </div>
                  ${itemsToDisplay.map(item => `
                      <div style="padding:8px;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center;">
                          <div style="flex:1;">
                              <div style="font-weight:600;color:#495057;font-size:12px;">${item.codigo} - ${item.descricao}</div>
                              <div style="font-size:11px;color:#6c757d;">${item.horas_formatted || decimalToTime(item.horas)} √ó R$ ${item.valor_hora.toFixed(2).replace('.', ',')} = <strong style="color:#007bff;">R$ ${item.subtotal.toFixed(2).replace('.', ',')}</strong></div>
                          </div>
                      </div>
                  `).join('')}
              `;
          }
          function filterValoresSelection() {
              const term = (document.getElementById('valoresSelectionSearch')?.value || '').toLowerCase();
              document.querySelectorAll('#valoresSelectionTableBody tr').forEach(row => {
                  if (row.classList.contains('setor-header')) return;
                  const t = (row.textContent || '').toLowerCase();
                  row.style.display = (t.includes(term) ? '' : 'none');
              });
          }
      </script>
      
      <!-- Barra de a√ß√µes moderna -->
      <div class="action-bar">
          <button class="action-btn dashboard-btn" title="Voltar ao Dashboard" onclick="window.location.href='/dashboard'">
              üè†
              <span class="label">Dashboard</span>
          </button>
          <button id="btnSalvar" class="action-btn save-btn" title="Carregando..." onclick="salvarAlteracoes()" disabled style="opacity: 0.5; cursor: not-allowed;">
              üíæ
              <span class="label">Carregando...</span>
          </button>
      </div>
  </div>
  
> <script>
          console.log('üîß Script carregado - verificando fun√ß√µes...');
          
          // Cache do usu√°rio atual para uso em assinaturas
          let __CURRENT_USER_NAME = null;
          let __CURRENT_USER_DEPT = null;
          
          // Fun√ß√£o para mostrar notifica√ß√µes
          function mostrarNotificacao(mensagem, tipo = 'success') {
              console.log('üì¢ Notifica√ß√£o:', mensagem, tipo);
              const notificacao = document.createElement('div');
              
              let background, shadow;
              if (tipo === 'error') {
                  background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                  shadow = 'rgba(220, 53, 69, 0.3)';
              } else {
                  background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                  shadow = 'rgba(40, 167, 69, 0.3)';
              }
              
              notificacao.style.cssText = `
                  position: fixed;
                  top: 20px;
                  right: 20px;
                  background: ${background};
                  color: white;
                  padding: 12px 20px;
                  border-radius: 8px;
                  box-shadow: 0 4px 15px ${shadow};
                  z-index: 3000;
                  animation: slideInRight 0.3s ease-out;
                  font-size: 14px;
                  font-weight: 500;
              `;
              
              notificacao.textContent = mensagem;
              document.body.appendChild(notificacao);
              
              setTimeout(() => {
                  notificacao.style.animation = 'slideOutRight 0.3s ease-in';
                  setTimeout(() => {
                      if (document.body.contains(notificacao)) {
                          document.body.removeChild(notificacao);
                      }
                  }, 300);
              }, 3000);
          }
  
          // Fun√ß√£o para verificar se h√° pelo menos uma assinatura
          function verificarAssinaturas() {
              console.log('üîç Verificando assinaturas...');
              const assinaturas = [
                  document.getElementById('nome_coluna1')?.textContent || '',
                  document.getElementById('nome_coluna2')?.textContent || '',
                  document.getElementById('nome_coluna3')?.textContent || ''
              ];
              
              console.log('üìù Assinaturas encontradas:', assinaturas);
              return assinaturas.some(assinatura => assinatura && assinatura !== 'NOME' && assinatura.trim() !== '');
          }
  
          // Fun√ß√£o chamada quando o setor respons√°vel √© alterado
          async function onAreaResponsavelChange() {
              console.log('üè¢ Setor respons√°vel alterado');
              const select = document.getElementById('area_responsavel_select');
              const selectedGroup = select.value;
              
              if (!selectedGroup) {
                  console.log('‚ö†Ô∏è Nenhum setor selecionado');
                  return;
              }
              
              console.log('üîç Buscando gerente do grupo:', selectedGroup);
              
              try {
                  // Buscar o gerente do grupo selecionado
                  const response = await fetch(`/admin/managers/api/group/${encodeURIComponent(selectedGroup)}/manager`, {
                      credentials: 'include'
                  });
                  
                  const data = await response.json();
                  
                  if (data.success && data.manager) {
                      console.log('‚úÖ Gerente encontrado:', data.manager.name);
                      
                      // Preencher assinatura automaticamente
                      const assResponsavelInput = document.getElementById('ass_responsavel');
                      if (assResponsavelInput && (!assResponsavelInput.value || assResponsavelInput.value.trim() === '')) {
                          assResponsavelInput.value = data.manager.name;
                          console.log('‚úçÔ∏è Assinatura respons√°vel preenchida automaticamente:', data.manager.name);
                          mostrarNotificacao(`‚úÖ Assinatura preenchida: ${data.manager.name}`, 'success');
                      }
                  } else {
                      console.warn('‚ö†Ô∏è Nenhum gerente definido para este setor');
                      mostrarNotificacao('‚ö†Ô∏è Nenhum gerente definido para este setor', 'error');
                  }
              } catch (error) {
                  console.error('‚ùå Erro ao buscar gerente:', error);
                  mostrarNotificacao('‚ùå Erro ao buscar gerente do setor', 'error');
              }
          }
          
          // Fun√ß√£o chamada quando o nome do respons√°vel √© alterado (causador)
          function onNomeResponsavelChange() {
              console.log('üë§ Nome respons√°vel (causador) alterado');
              // Aqui pode adicionar l√≥gica adicional se necess√°rio
          }
  
          // Fun√ß√£o para preencher assinatura automaticamente
          function preencherAssinatura(elemento) {
              console.log('‚úçÔ∏è Preenchendo assinatura...');
              const nomeElement = elemento.querySelector('div[id^="nome_coluna"]');
              // Se j√° existe assinatura, n√£o permitir remover (travado)
              if (nomeElement && nomeElement.textContent && nomeElement.textContent.trim() !== '' && nomeElement.textContent !== 'NOME') {
                  mostrarNotificacao('Assinatura j√° registrada.');
                  return;
              }
              
              fetch('/api/user/info')
                  .then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          const nomeUsuario = data.user.name;
                          const departamento = data.user.department;
                          
                          if (nomeElement) {
                              nomeElement.textContent = `${nomeUsuario} (${departamento})`;
                              
                              elemento.style.transform = 'scale(1.02)';
                              elemento.style.transition = 'transform 0.2s ease';
                              
                              setTimeout(() => {
                                  elemento.style.transform = 'scale(1)';
                              }, 200);
                              
                              mostrarNotificacao('‚úÖ Assinatura preenchida automaticamente!');
                              // Preencher data correspondente e travar inputs
                              const hoje = new Date();
                              const d = String(hoje.getDate()).padStart(2,'0');
                              const m = String(hoje.getMonth()+1).padStart(2,'0');
                              const y = String(hoje.getFullYear());
                              if (elemento.id === 'assinatura_coluna1') {
                                  setDateInputs('insp1', d, m, y);
                              } else if (elemento.id === 'assinatura_coluna2') {
                                  setDateInputs('eng', d, m, y);
                              } else if (elemento.id === 'assinatura_coluna3') {
                                  setDateInputs('insp2', d, m, y);
                              }
                          }
                      } else {
                          mostrarNotificacao('‚ùå Erro: Usu√°rio n√£o autenticado', 'error');
                      }
                  })
                  .catch(error => {
                      console.error('Erro ao buscar informa√ß√µes do usu√°rio:', error);
                      mostrarNotificacao('‚ùå Erro ao preencher assinatura', 'error');
                  });
          }
  
          function setDateInputs(prefix, d, m, y) {
              const di = document.getElementById(prefix + '_d');
              const mi = document.getElementById(prefix + '_m');
              const yi = document.getElementById(prefix + '_y');
              if (di && mi && yi) {
                  di.value = d; mi.value = m; yi.value = y;
                  di.readOnly = true; mi.readOnly = true; yi.readOnly = true;
                  di.style.pointerEvents='none'; mi.style.pointerEvents='none'; yi.style.pointerEvents='none';
              }
          }
  
          // Fun√ß√£o para salvar altera√ß√µes (implementa√ß√£o completa)
          window.salvarAlteracoes = function salvarAlteracoes() {
              console.log('üíæ Fun√ß√£o salvarAlteracoes chamada!');
              
              // Verificar se h√° pelo menos uma assinatura
              if (!verificarAssinaturas()) {
                  mostrarNotificacao('‚ùå √â obrigat√≥rio preencher pelo menos uma assinatura!', 'error');
                  return;
              }
  
              // Normalizar: se data foi preenchida e nome ficou 'NOME', completar com usu√°rio atual
              (function normalizeSignatures(){
                  const s = [
                      {prefix:'insp1', id:'nome_coluna1'},
                      {prefix:'eng', id:'nome_coluna2'},
                      {prefix:'insp2', id:'nome_coluna3'}
                  ];
                  s.forEach(({prefix,id})=>{
                      const nameEl = document.getElementById(id);
                      const di = document.getElementById(prefix+'_d');
                      const mi = document.getElementById(prefix+'_m');
                      const yi = document.getElementById(prefix+'_y');
                      const dateFilled = (di?.value||'')!=='' || (mi?.value||'')!=='' || (yi?.value||'')!=='';
                      const hasName = nameEl && nameEl.textContent && nameEl.textContent.trim()!=='' && nameEl.textContent!=='NOME';
                      if (dateFilled && !hasName) {
                          if (nameEl && __CURRENT_USER_NAME) {
                              nameEl.textContent = __CURRENT_USER_NAME + (__CURRENT_USER_DEPT ? ' ('+__CURRENT_USER_DEPT+')' : '');
                          }
                      }
                  });
              })();
  
              // üîí PRIMEIRO: DETECTAR TODOS OS CAMPOS BLOQUEADOS
              {% if is_reply %}
              // Esta vari√°vel ser√° preenchida pela API de campos bloqueados
              window.apiBlockedFields = window.apiBlockedFields || [];
              const disabledFieldNames = new Set(window.apiBlockedFields);
              
              // 1. Detectar inputs/textareas/selects desabilitados diretamente
              document.querySelectorAll('input:disabled, select:disabled, textarea:disabled').forEach(el => {
                  if (el.id) {
                      disabledFieldNames.add(el.id);
                  }
              });
              
              console.log('üîí Campos bloqueados detectados:', Array.from(disabledFieldNames));
              console.log('üîí Campos bloqueados da API:', window.apiBlockedFields);
              {% endif %}
              
              // üîí SEGUNDO: COLETAR APENAS CAMPOS N√ÉO BLOQUEADOS
              const formData = {};
              
              {% if is_reply %}
              // Modo RESPOSTA: adicionar apenas se N√ÉO bloqueado
              
              // Informa√ß√µes principais
              if (!disabledFieldNames.has('title')) {
                  formData.title = document.getElementById('title')?.value ?? {{ (rnc.title or "") | tojson }};
              }
              if (!disabledFieldNames.has('description')) {
                  formData.description = document.getElementById('description')?.value ?? {{ (rnc.description or "") | tojson }};
              }
              if (!disabledFieldNames.has('equipment')) {
                  formData.equipment = document.getElementById('equipment')?.value ?? {{ (rnc.equipment or "") | tojson }};
              }
              if (!disabledFieldNames.has('client')) {
                  formData.client = document.getElementById('client')?.value ?? {{ (rnc.client or "") | tojson }};
              }
              if (!disabledFieldNames.has('rnc_number')) {
                  formData.rnc_number = document.getElementById('rnc_number')?.value || {{ rnc.rnc_number | tojson }};
              }
              
              // Dados t√©cnicos do produto
              if (!disabledFieldNames.has('mp')) {
                  formData.mp = document.getElementById('mp')?.value || '';
              }
              if (!disabledFieldNames.has('revision')) {
                  formData.revision = document.getElementById('revision')?.value || '';
              }
              if (!disabledFieldNames.has('position')) {
                  formData.position = document.getElementById('position')?.value || '';
              }
              if (!disabledFieldNames.has('cv')) {
                  formData.cv = document.getElementById('cv')?.value || '';
              }
              if (!disabledFieldNames.has('conjunto')) {
                  formData.conjunto = document.getElementById('conjunto')?.value || '';
              }
              if (!disabledFieldNames.has('modelo')) {
                  formData.modelo = document.getElementById('modelo')?.value || '';
              }
              if (!disabledFieldNames.has('description_drawing')) {
                  formData.description_drawing = document.getElementById('description_drawing')?.value || '';
              }
              if (!disabledFieldNames.has('quantity')) {
                  formData.quantity = document.getElementById('quantity')?.value || '';
              }
              if (!disabledFieldNames.has('material')) {
                  formData.material = document.getElementById('material')?.value || '';
              }
              if (!disabledFieldNames.has('purchase_order')) {
                  formData.purchase_order = document.getElementById('purchase_order')?.value || '';
              }
              
              // Responsabilidades
              if (!disabledFieldNames.has('responsavel')) {
                  formData.responsavel = document.getElementById('responsavel')?.value || '';
              }
              if (!disabledFieldNames.has('inspetor')) {
                  formData.inspetor = document.getElementById('inspetor')?.value || '';
              }
              if (!disabledFieldNames.has('area_responsavel')) {
                  formData.area_responsavel = document.getElementById('area_responsavel')?.value || '';
              }
              if (!disabledFieldNames.has('created_at')) {
                  formData.created_at = document.getElementById('created_at')?.value || '';
              }
              
              // Se√ß√µes textuais
              if (!disabledFieldNames.has('instruction_retrabalho')) {
                  formData.instruction_retrabalho = document.getElementById('instruction_retrabalho')?.value || '';
              }
              if (!disabledFieldNames.has('cause_rnc')) {
                  formData.cause_rnc = document.getElementById('cause_rnc')?.value || '';
              }
              if (!disabledFieldNames.has('action_rnc')) {
                  formData.action_rnc = document.getElementById('action_rnc')?.value || '';
              }
              
              // Valor/Custo
              if (!disabledFieldNames.has('price')) {
                  {
                      const priceRaw = document.getElementById('price')?.value || '';
                      const numeric = parseFloat(String(priceRaw).replace(/[^0-9,.-]/g,'').replace(/\.(?=\d{3})/g,'').replace(',', '.'));
                      formData.price = isNaN(numeric) ? null : numeric;
                  }
                  formData.price_note = document.getElementById('price_note')?.value || '';
              }
              
              {% else %}
              // Modo CRIA√á√ÉO: coletar todos os campos normalmente
              formData.title = document.getElementById('title')?.value ?? {{ (rnc.title or "") | tojson }};
              formData.description = document.getElementById('description')?.value ?? {{ (rnc.description or "") | tojson }};
              formData.equipment = document.getElementById('equipment')?.value ?? {{ (rnc.equipment or "") | tojson }};
              formData.client = document.getElementById('client')?.value ?? {{ (rnc.client or "") | tojson }};
              formData.rnc_number = document.getElementById('rnc_number')?.value || {{ rnc.rnc_number | tojson }};
              formData.mp = document.getElementById('mp')?.value || '';
              formData.revision = document.getElementById('revision')?.value || '';
              formData.position = document.getElementById('position')?.value || '';
              formData.cv = document.getElementById('cv')?.value || '';
              formData.conjunto = document.getElementById('conjunto')?.value || '';
              formData.modelo = document.getElementById('modelo')?.value || '';
              formData.description_drawing = document.getElementById('description_drawing')?.value || '';
              formData.quantity = document.getElementById('quantity')?.value || '';
              formData.material = document.getElementById('material')?.value || '';
              formData.purchase_order = document.getElementById('purchase_order')?.value || '';
              formData.assigned_user_id = document.getElementById('assigned_user_id')?.value || '';
              formData.responsavel = document.getElementById('responsavel')?.value || '';
              formData.inspetor = document.getElementById('inspetor')?.value || '';
              formData.area_responsavel = document.getElementById('area_responsavel')?.value || '';
              formData.created_at = document.getElementById('created_at')?.value || '';
              formData.instruction_retrabalho = document.getElementById('instruction_retrabalho')?.value || '';
              formData.cause_rnc = document.getElementById('cause_rnc')?.value || '';
              formData.action_rnc = document.getElementById('action_rnc')?.value || '';
              {
                  const priceRaw = document.getElementById('price')?.value || '';
                  const numeric = parseFloat(String(priceRaw).replace(/[^0-9,.-]/g,'').replace(/\.(?=\d{3})/g,'').replace(',', '.'));
                  formData.price = isNaN(numeric) ? null : numeric;
              }
              formData.price_note = document.getElementById('price_note')?.value || '';
              {% endif %}
  
              {% if is_reply %}
              // üîí ADICIONAR mapeamentos e detectar checkboxes/datas/assinaturas bloqueadas
              try {
                  const checkboxMap = {
                      'usar': 'disposition_usar',
                      'retrabalhar': 'disposition_retrabalhar',
                      'rejeitar': 'disposition_rejeitar',
                      'sucata': 'disposition_sucata',
                      'devolver_estoque': 'disposition_devolver_estoque',
                      'devolver_fornecedor': 'disposition_devolver_fornecedor',
                      'aprovado': 'inspection_aprovado',
                      'reprovado': 'inspection_reprovado'
                  };
                  
                  const dateFieldMap = {
                      'insp1': 'signature_inspection_date',
                      'eng': 'signature_engineering_date',
                      'insp2': 'signature_inspection2_date'
                  };
                  
                  const signatureMap = {
                      'nome_coluna1': 'signature_inspection_name',
                      'nome_coluna2': 'signature_engineering_name',
                      'nome_coluna3': 'signature_inspection2_name'
                  };
                  
                  // Adicionar checkboxes desabilitados ao Set
                  Object.keys(checkboxMap).forEach(checkboxId => {
                      const checkbox = document.getElementById(checkboxId);
                      if (checkbox && checkbox.disabled) {
                          disabledFieldNames.add(checkboxMap[checkboxId]);
                      }
                  });
  
                  // Se o campo de pre√ßo estiver bloqueado/disabled, desabilitar o bot√£o de adicionar valores
                  try {
                      const priceEl = document.getElementById('price');
                      const addBtn = document.getElementById('addValoresBtn');
                      if (priceEl && priceEl.disabled && addBtn) {
                          addBtn.disabled = true;
                          addBtn.style.opacity = '0.6';
                          addBtn.style.cursor = 'not-allowed';
                      }
                  } catch (_) {}
                  
                  // Adicionar campos de data desabilitados ao Set
                  Object.keys(dateFieldMap).forEach(prefix => {
                      const d = document.getElementById(prefix + '_d');
                      const m = document.getElementById(prefix + '_m');
                      const y = document.getElementById(prefix + '_y');
                      if ((d && d.disabled) || (m && m.disabled) || (y && y.disabled)) {
                          disabledFieldNames.add(dateFieldMap[prefix]);
                      }
                  });
                  
                  // Adicionar assinaturas bloqueadas ao Set
                  Object.keys(signatureMap).forEach(sigId => {
                      const sigEl = document.getElementById(sigId);
                      const parent = sigEl?.closest('div');
                      if (parent && parent.style.cursor === 'not-allowed') {
                          disabledFieldNames.add(signatureMap[sigId]);
                      }
                  });
                  
                  console.log('üîí Total de campos bloqueados:', Array.from(disabledFieldNames));
                  
                  // ADICIONAR APENAS SE N√ÉO BLOQUEADOS
                  
                  // Assinaturas
                  if (!disabledFieldNames.has('signature_inspection_name')) {
                      formData.signature_inspection_name = document.getElementById('nome_coluna1')?.textContent || '';
                  }
                  if (!disabledFieldNames.has('signature_engineering_name')) {
                      formData.signature_engineering_name = document.getElementById('nome_coluna2')?.textContent || '';
                  }
                  if (!disabledFieldNames.has('signature_inspection2_name')) {
                      formData.signature_inspection2_name = document.getElementById('nome_coluna3')?.textContent || '';
                  }
                  
                  // ‚úÖ CORRE√á√ÉO: Datas de assinatura s√≥ devem ser enviadas se N√ÉO estiverem bloqueadas
                  // Campos bloqueados n√£o devem ser enviados ao backend (o banco j√° tem os valores corretos)
                  if (!disabledFieldNames.has('signature_inspection_date')) {
                      formData.signature_inspection_date = [
                          document.getElementById('insp1_d')?.value||'',
                          document.getElementById('insp1_m')?.value||'',
                          document.getElementById('insp1_y')?.value||''
                      ].join('/');
                  }
                  
                  if (!disabledFieldNames.has('signature_engineering_date')) {
                      formData.signature_engineering_date = [
                          document.getElementById('eng_d')?.value||'',
                          document.getElementById('eng_m')?.value||'',
                          document.getElementById('eng_y')?.value||''
                      ].join('/');
                  }
                  
                  if (!disabledFieldNames.has('signature_inspection2_date')) {
                      formData.signature_inspection2_date = [
                          document.getElementById('insp2_d')?.value||'',
                          document.getElementById('insp2_m')?.value||'',
                          document.getElementById('insp2_y')?.value||''
                      ].join('/');
                  }
                  
                  console.log('üìÖ Datas de assinatura enviadas:', {
                      inspection: formData.signature_inspection_date || '(bloqueado - n√£o enviado)',
                      engineering: formData.signature_engineering_date || '(bloqueado - n√£o enviado)',
                      inspection2: formData.signature_inspection2_date || '(bloqueado - n√£o enviado)'
                  });
                  
                  // Checkboxes de disposi√ß√£o
                  if (!disabledFieldNames.has('disposition_usar')) {
                      formData.disposition_usar = document.getElementById('usar')?.checked || false;
                  }
                  if (!disabledFieldNames.has('disposition_retrabalhar')) {
                      formData.disposition_retrabalhar = document.getElementById('retrabalhar')?.checked || false;
                  }
                  if (!disabledFieldNames.has('disposition_rejeitar')) {
                      formData.disposition_rejeitar = document.getElementById('rejeitar')?.checked || false;
                  }
                  if (!disabledFieldNames.has('disposition_sucata')) {
                      formData.disposition_sucata = document.getElementById('sucata')?.checked || false;
                  }
                  if (!disabledFieldNames.has('disposition_devolver_estoque')) {
                      formData.disposition_devolver_estoque = document.getElementById('devolver_estoque')?.checked || false;
                  }
                  if (!disabledFieldNames.has('disposition_devolver_fornecedor')) {
                      formData.disposition_devolver_fornecedor = document.getElementById('devolver_fornecedor')?.checked || false;
                  }
                  
                  // Inspe√ß√£o do retrabalho
                  if (!disabledFieldNames.has('inspection_aprovado')) {
                      formData.inspection_aprovado = document.getElementById('aprovado')?.checked || false;
                  }
                  if (!disabledFieldNames.has('inspection_reprovado')) {
                      formData.inspection_reprovado = document.getElementById('reprovado')?.checked || false;
                  }
                  if (!disabledFieldNames.has('inspection_ver_rnc')) {
                      formData.inspection_ver_rnc = document.getElementById('ver_rnc_input')?.value || '';
                  }
                  
                  // Status
                  if (!disabledFieldNames.has('status')) {
                      formData.status = 'Pendente';
                      console.log('‚úÖ Status definido como Pendente (campo permitido)');
                  } else {
                      console.log('‚ö†Ô∏è  Status N√ÉO adicionado (campo bloqueado)');
                  }
                  
                  console.log('‚úÖ Payload final (apenas campos permitidos):', formData);
                  
              } catch(e) {
                  console.error('‚ùå Erro ao filtrar campos bloqueados:', e);
              }
              {% else %}
              // Modo cria√ß√£o - enviar todos os campos normalmente
              formData.signature_inspection_name = document.getElementById('nome_coluna1')?.textContent || '';

